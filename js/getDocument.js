var obj = {
    "items":"[{\"name\":\"vk\",\"userData\":\"[{\\\"title\\\":\\\"16 марта отмечается 6-я годовщина Референдума о вхождении Кр...\\\",\\\"link\\\":\\\"https://vk.com/wall-60550151_3421\\\"},{\\\"title\\\":\\\"В отделениях дневного пребывания Центра социального обслужив...\\\",\\\"link\\\":\\\"https://vk.com/wall-150913358_740\\\"},{\\\"title\\\":\\\"[id289101014|Александр], Годовщина крымского скотства \\\\n¯¯¯¯¯...\\\",\\\"link\\\":\\\"https://vk.com/wall410606173_68854\\\"},{\\\"title\\\":\\\"Шестой годовщине воссоединения Крыма с Россией было посвящен...\\\",\\\"link\\\":\\\"https://vk.com/wall-128895214_3484\\\"},{\\\"title\\\":\\\"😎ЭКСКУРСИОННЫЙ ТУР В КРЫМ ДЛЯ ПЕНСИОНЕРОВ 🥰\\\\n\\\\n5 дней /4 ноч...\\\",\\\"link\\\":\\\"https://vk.com/wall-95980194_18524\\\"},{\\\"title\\\":\\\"«Крымская весна»\\\\n\\\\n18 марта 2020г. Солецкий краеведческий муз...\\\",\\\"link\\\":\\\"https://vk.com/wall-117321834_1944\\\"},{\\\"title\\\":\\\"‼Группа «ЧИЧЕРИНА». 20 ЛЕТ В ПУТИ - новая дата 8 декабря 202...\\\",\\\"link\\\":\\\"https://vk.com/wall-39219581_2548\\\"},{\\\"title\\\":\\\"16 марта 2014 года состоялся общекрымский референдум. Судьбо...\\\",\\\"link\\\":\\\"https://vk.com/wall-173009752_459\\\"},{\\\"title\\\":\\\"Президент Путин-2036: а есть ли другие варианты?\\\\n\\\\nМоментальн...\\\",\\\"link\\\":\\\"https://vk.com/wall-76521728_83835\\\"},{\\\"title\\\":\\\"СВОДКИ ОТ «ВЕСТНИКА СОВЕТСКОЙ НОВОРОССИИ» ОТ 06 МАРТА 2020г ...\\\",\\\"link\\\":\\\"https://vk.com/wall-147250560_71134\\\"}]\"},{\"name\":\"google\",\"userData\":\"[{\\\"title\\\":\\\"Крымская весна — Википедия...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9A%D1%80%D1%8B%D0%BC%D1%81%D0%BA%D0%B0%D1%8F_%D0%B2%D0%B5%D1%81%D0%BD%D0%B0\\\"},{\\\"title\\\":\\\"Крымская весна». Документальный фильм Сергея Холошевского...\\\",\\\"link\\\":\\\"https://www.youtube.com/watch?v\\\=IX62FV9TCSU\\\"},{\\\"title\\\":\\\"Крымская весна 2014 (Russian Edition) eBook ... - Amazon.com...\\\",\\\"link\\\":\\\"https://www.amazon.com/%D0%9A%D1%80%D1%8B%D0%BC%D1%81%D0%BA%D0%B0%D1%8F-%D0%B2%D0%B5%D1%81%D0%BD%D0%B0-2014-Russian-%D0%90%D0%B3%D0%B0%D1%82%D0%BE%D0%B2-%D0%9C%D0%B0%D1%80%D0%BA-ebook/dp/B01EJW2EOE\\\"},{\\\"title\\\":\\\"Керчь: «Крымская весна». Как это было - YouTube...\\\",\\\"link\\\":\\\"https://www.youtube.com/watch?v\\\=wIg6WkwMd9k\\\"},{\\\"title\\\":\\\"Марк Агатов, Крымская весна 2014 – скачать fb2, epub, pdf на ......\\\",\\\"link\\\":\\\"https://www.litres.ru/mark-agatov/krymskaya-vesna-2014/\\\"},{\\\"title\\\":\\\"\\\\\\\"Крымская весна\\\\\\\" | официальный сайт...\\\",\\\"link\\\":\\\"https://krvesna.rk.gov.ru/\\\"},{\\\"title\\\":\\\"\\\\\\\"Крымская весна\\\\\\\": ТАСС публикует видео о событиях 2014 года ......\\\",\\\"link\\\":\\\"https://tass.ru/politika/2751671\\\"},{\\\"title\\\":\\\"КРЫМСКАЯ ВЕСНА 2014 ГОДА...\\\",\\\"link\\\":\\\"http://ruslo.cz/index.php/nauka/item/500-krymskaya-vesna-2014-goda\\\"},{\\\"title\\\":\\\"Выставка \\\\\\\"Тридцать дней, который потрясли мир: \\\\\\\"Крымская ......\\\",\\\"link\\\":\\\"http://tavrida-museum.ru/news/item/624-vystavka-tridtsat-dnej-kotoryj-potryasli-mir-krymskaya-vesna-2014-goda\\\"},{\\\"title\\\":\\\"«Крымская весна». Фильм Сергея Холошевского...\\\",\\\"link\\\":\\\"https://www.ntv.ru/video/779460/\\\"}]\"},{\"name\":\"yandex\",\"userData\":\"[{\\\"title\\\":\\\"Присоединение Крыма к Российской Федерации......\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Крымская весна 2014 — 4 тыс. видео...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Пятилетие « крымской весны»: малоизвестные события......\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Крымская Весна 2014 - YouTube...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"«Никто не верил, что это всерьез» Как присоединяли......\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Самые яркие моменты Крымской весны- 2014 на видео...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Путин посетит Севастополь в годовщину \\\\\\\" крымской весны\\\\\\\"...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Крымская весна 2014-го: как это было. Взгляд из Москвы...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Крым 2014. Силы специальных операций. | Яндекс Дзен...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Хроника Крымской весны: 18 марта 2014 года......\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Крымская весна. Хроника событий...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"Краткая хроника событий « Крымской весны» 2014 года...\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"},{\\\"title\\\":\\\"«Нас бы уничтожили»: участница « Крымской весны»......\\\",\\\"link\\\":\\\"https://ru.wikipedia.org/wiki/%D0%9F%D1%80%D0%B8%D1%81%D0%BE%D0%B5%D0%B4%D0%B8%D0%BD%D0%B5%D0%BD%D0%B8%D0%B5_%D0%9A%D1%80%D1%8B%D0%BC%D0%B0_%D0%BA_%D0%A0%D0%BE%D1%81%D1%81%D0%B8%D0%B9%D1%81%D0%BA%D0%BE%D0%B9_%D0%A4%D0%B5%D0%B4%D0%B5%D1%80%D0%B0%D1%86%D0%B8%D0%B8\\\"}]\"}]"
};


document.getElementById("getDomBtn").addEventListener('click', () => {

    chrome.tabs.executeScript( {
      code: "window.getSelection().toString();"
  }, function(selection) {

    console.log("HERE IS THE SELECTION --->" + selection[0]);
    

    var userData = new Object();
    userData.selection = selection[0];
    userData.sources = [];
    $("input:checkbox[name='source']:checked").each(function(){
        userData.sources.push($(this).val());
    });
    userData = JSON.stringify(userData);



    if (localStorage['userData']) {

        var json_str = JSON.parse(getLocalStorage('userData'));
        var token = json_str.access_token;

        $.ajax({
            url: 'http://localhost:9090/note',
            type: 'POST',
            headers: {
                "Authorization": "Bearer " + token,
                'Content-Type': 'application/json; charset=utf-8'
            },
            dataType : 'json',
            data: userData ,
            success: function () { console.log("success!"); },
            error: function () { },
        });
    }

    var myJSON;
    var xhr = new XMLHttpRequest();

    xhr.open("POST", 'http://localhost:7070/greeting', true)
    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');

    xhr.onreadystatechange = function(){
        if(xhr.readyState == 4 && xhr.status == 200) {
          console.log(xhr.responseText);

          myJSON = JSON.stringify(xhr.responseText);
          executeContentScript(myJSON);
          
      }
  };

  xhr.send(userData);

});

/*    var myJSON = JSON.stringify(obj);
executeContentScript(myJSON);*/


});

function executeContentScript(myJSON) {
   chrome.tabs.query({active: true}, function(tabs){
      chrome.tabs.executeScript(tabs[0].id,{file: "/js/jquery.js"}, function(){
        chrome.tabs.executeScript({file: "/js/tabScript.js"}, function(){
            chrome.tabs.sendMessage(tabs[0].id, {scriptOptions: {jsonData : myJSON}}, function(){
                                        //all injected
                                    });
        });
    });
  });
}

